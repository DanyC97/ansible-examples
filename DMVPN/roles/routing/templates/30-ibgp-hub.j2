router bgp {{as}}
 redistribute ospf 1 match internal
 no synchronization
 neighbor spokes peer-group
 neighbor spokes remote-as {{as}}
 neighbor spokes route-reflector-client
 neighbor spokes default-originate
 neighbor spokes send-community
{% for ifnum,intf in DMVPN|default({})|dictsort %}
{%   set ifip = intf.ip+"/24" %}
 bgp listen range {{ifip|ipaddr(0)}} peer-group spokes
{% endfor %}
{% for hub in groups['hubs'] %}
{%   if hub != inventory_hostname %}
{%     set peerip = hostvars[hub].loopback.ip %}
 neighbor {{peerip}} remote-as {{as}}
 neighbor {{peerip}} next-hop-self all
{%   endif %}
{% endfor %}

!
{% if loopback.ip is defined %}
interface Loopback0
 ip ospf 1 area 0
{% endif %}
!
{% if LAN is defined %}
interface {{LAN.interface}}
 ip ospf 1 area 0
{% endif %}
